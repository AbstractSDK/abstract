version: 2.1

orbs:
  codecov: codecov/codecov@3.2.2

parameters:
  run_modules_coverage:
    type: boolean
    default: false
  run_framework_coverage:
    type: boolean
    default: false    

workflows:
  version: 2
  build:
    jobs:
      - build
  coverage:
    when: << pipeline.parameters.GHA_Event == "modules_coverage" >>
    jobs: 
      - coverage

jobs:
  build:
    docker:
      - image: cimg/rust:1.55
    steps:
      - setup_remote_docker:
          version: 20.10.14
      - checkout
      - run:
          name: Build WASM artifacts
          command: |
            ./scripts/wasm-all-ci.sh
      - run:
          name: Commit and push artifacts
          command: |
            git config --global user.name 'CircleCI'
            git config --global user.email 'circleci@example.com'
            git add .
            git commit -m 'Update WASM artifacts [skip ci]'
            git push origin $CIRCLE_BRANCH

  coverage:
    # https://circleci.com/developer/images?imageType=machine
    machine:
      image: ubuntu-2004:202201-02
    steps:
      - checkout
      - run:
          name: Run tests with coverage for modules
          command: |
            cd ./modules
            mkdir -p cov
            docker run --security-opt seccomp=unconfined -v "${PWD}:/volume" xd009642/tarpaulin \
              sh -c "cargo tarpaulin --skip-clean --frozen --out Xml --output-dir cov"
      - codecov/upload:
          file: cov/cobertura.xml
